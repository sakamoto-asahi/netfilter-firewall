# netfilter-firewall
netfilter-firewallは、Linuxカーネルのパケット処理フレームワーク`Netfilter`のNFQUEUEターゲットによりパケットをカーネルからユーザ空間に転送し、`libnetfilter_queue`ライブラリを用いてパケットを解析・処理するファイアウォールです。<br><br>
このファイアウォールはNetfilterに依存するため、**Linux環境でのみ動作します。**<br><br>
本プロジェクトでは、以下の二つのコマンドを提供します。
* `nfw`：ファイアウォール本体。NFQUEUEからパケットを受け取り、ルールに基づいたフィルタリング処理を行います。
* `nfw-ctl`：ファイアウォールの設定変更やルール管理を行う制御用コマンド。UNIXドメインソケット経由で`nfw`と通信します。

## 機能一覧
### パケットフィルタリング
ユーザが定義したルールに基づいて、**プロトコル**/**IPアドレス**/**ポート番号**/**アクション**によるアクセス制御を行います。
* ルールは**INPUT**と**OUTPUT**のチェインごとに存在します。
* ルールは上から順に評価され、最初に一致したルールが適用されます。
* 一致するルールが存在しなければ、デフォルトポリシーによりアクセス制御が行われます。
### ステートフルインスペクション
**ICMP**、**TCP**、**UDP**のセッション状態を追跡し、既存の通信に対する応答パケットを効率的に許可します。
* 双方向リストでステートテーブルを管理します。
* 定期的にテーブルのエントリーがタイムアウトしていないか確認します。
### ファイアウォール制御コマンド
`nfw-ctl`のサブコマンドにより、実行中のファイアウォールに対してルールや設定を変更することができます。<br>
ルールや設定の変更は、UNIXドメインソケット経由でファイアウォールに安全に反映されます。<br><br>
サブコマンドには以下の命令があります：
* ルールの追加・更新・削除
* ルールのインポート・エクスポート
* デフォルトポリシーの変更
* デフォルトログ設定の変更
* 設定ファイルの再読み込み
* ファイアウォール本体のシャットダウン
### ログ取得機能
パケットの処理結果をログとしてファイルに記録することができます。
* ログには、パケットの情報や取得時間、一致したルールなどが記録されます。
* ログは`log/packet.log`に保存されます。
* ログローテーションにより、一定容量のログが溜まると新しいファイルが作成され、そこにログが記録されます。

## 使用技術
| 技術 | 使用目的 |
| - | - |
| C言語 | ファイアウォール本体および制御コマンドの実装に使用した開発言語。 |
| gcc | C言語のコンパイラ。`-Wall`オプションを用いて詳細な警告を表示する。 |
| Make | ビルドの自動化ツール。`nfw`・`nfw-ctl`のコンパイル、オブジェクトファイルの生成、リンクの自動化を行う。 |
| Docker | 実行環境の統一と配布のため使用。必要なライブラリ・ツールが揃ったLinux環境をコンテナ内に再現し、どの環境でもファイアウォールを動作させることができる。 |
| Netfilter | Linuxカーネルのパケット処理フレームワーク。NFQUEUEターゲットを用いて、パケットをユーザ空間に転送する。 |
| nftables | Netfilterの設定管理ツール。パケットをNFQUEUEへリダイレクトするルールを設定する。 |
| libnetfilter_queue | NFQUEUEに送られてきたパケットをユーザ空間で受信し、解析結果（ACCEPT / DROP）をカーネルに返すためのライブラリ。 |
| POSIXスレッド（pthread） | `nfw`内部で以下の並行処理を実装：<br>・パケット処理スレッド<br>・ステートテーブルのタイムアウトを監視するスレッド<br>・UNIXドメインソケットを介したCLIリクエスト受付スレッド |
| UNIXドメインソケット | `nfw`と`nfw-ctl`のプロセス間通信に使用。ルール更新・設定変更・シャットダウン命令などをリアルタイムに反映できる。 |
| シグナルハンドラ | `SIGINT`や`SIGTERM`を受け取った際、キューとステートテーブルの解放、ソケットとファイルのクローズなどのクリーンアップ処理を行い、異常終了を防止するために使用。 |

## 導入方法
ここでは、netfilter-firewallと実行環境を導入する方法を説明します。<br>
前提として**Git**と**Docker**がインストールされている必要があります。
### 1. ソースコードの取得
Gitがインストールされている環境で以下のコマンドを実行します。
```
git clone https://github.com/sakamoto-asahi/netfilter-firewall.git
cd netfilter-firewall
```
### 2. Dockerイメージのビルド
取得した`Dockerfile`を使ってDockerイメージをビルドします。このステップで、コンテナ内のソースコードがコンパイルされ、プログラムのパスが通ります。
```
docker build -t netfilter-firewall .
```
### 3. コンテナの起動
最後に、ビルドしたDockerイメージからコンテナを起動します。
コンテナの起動後、`docker-entrypoint.sh`スクリプトが実行され、`/etc/nftables.conf`に基づいてNFQUEUEへのパケット転送ルールを適用し、その後`bash`シェルが起動されます。<br>
これで環境構築は完了し、netfilter-firewallを実行できます。
```
docker run --name fw-main --cap-add=NET_ADMIN -it netfilter-firewall
```
**【オプション解説】**
* `--name`：コンテナに`fw-main`という名前を付けます。
* `--cap-add=NET_ADMIN` : NFQUEUEのルール設定を行うための権限をコンテナに付与します。
* `-it` : コンテナを対話モードで起動し、`bash`シェルへアクセスをします。

二回目以降の起動には以下のコマンドを使用します：
```
docker start -ai fw-main
```
作業を終えたら`exit`でシェルを終了し、コンテナを停止します。
```
exit
```
### コンテナ・イメージの削除方法
コンテナが不要になったら以下のコマンドで削除します。
```
docker rm fw-main
```
イメージの削除は以下のコマンドを使用します。
```
docker rmi netfilter-firewall
```

## ファイアウォールの実行方法
ファイアウォールの実行には、コンテナを起動しシェルに入った状態で、`nfw`プログラムをバックグラウンドで実行します。
```
nfw &
```
ファイアウォールを終了するには、`nfw-ctl`の`shutdown`コマンドを実行します。<br>
`shutdown`コマンドを実行すると、各スレッドの終了を待ってから、クリーンアップ処理を実行してプログラムが終了します。
```
nfw-ctl shutdown
```

## ファイアウォールの制御コマンド使用方法
`nfw-ctl`は、フィルタリングルールの追加・編集・削除や、ファイアウォールの設定を行うサブコマンドを提供します。コマンドによってはオプションを指定する必要があります。
### nfw-ctlコマンドのオプション
| オプション | 引数 | 説明 |
| - | - | - |
| `-c`, `--chain` | `INPUT`, `OUTPUT` | チェインの指定 |
| `-p`, `--protocol` | `ICMP`, `TCP`, `UDP` または、`ANY` | プロトコルの指定 |
| `-s`, `--src-ip` | `IPアドレス` または、`ANY` | 送信元IPアドレスの指定 |
| `-S`, `--src-port` | `ポート番号` または、`ANY` | 送信元ポート番号の指定 |
| `-d`, `--dst-ip` | `IPアドレス` または、`ANY` | 宛先IPアドレスの指定 |
| `-D`, `--dst-port` | `ポート番号` または、`ANY` | 宛先ポート番号の指定 |
| `-a`, `--action` | `ACCEPT`, `DROP` | パケットのアクションの指定 |
| `-l`, `--log` | `LOG`, `NOLOG` | ログ設定の指定 |
| `-r`, `--rule` | `ENABLED`, `DISABLED` | フィルタリングルールの有効・無効化 |
### ルールの表示（`show`）
`show`コマンドは、現在のフィルタリングルールを**INPUT**と**OUTPUT**に分けて表示します。
```
nfw-ctl show
```
出力結果の例：
```
INPUT (ポリシー：DROP, デフォルトログ：OFF)
番号  プロトコル   送信元アドレス           宛先アドレス            アクション   ログ   有効
----  ----------  ---------------------  ---------------------  ----------  -----  --------
1     TCP         192.168.1.0:ANY        ANY:ANY                ACCEPT      NOLOG  ENABLED
2     UDP         203.0.113.8:8080       ANY:ANY                DROP        NOLOG  ENABLED
3     ICMP        ANY                    ANY                    DROP        LOG    ENABLED

OUTPUT (ポリシー：ACCEPT, デフォルトログ：OFF)
番号  プロトコル   送信元アドレス           宛先アドレス            アクション   ログ   有効
----  ----------  ---------------------  ---------------------  ----------  -----  --------
1     ICMP        ANY                    ANY                    ACCEPT      LOG    ENABLED
2     TCP         ANY:ANY                172.16.0.4:ANY         DROP        NOLOG  DISABLED
```
* `番号`：既存ルールの編集を行う際に指定が必要となる行番号が表示されます。
* `ポリシー`：どのルールとも一致しなかったパケットのデフォルトのアクションが表示されます。
* `デフォルトログ`：どのルールとも一致しなかったパケットのログの有無が表示されます。
### ルールの追加（`add`）
`add`コマンドは、ファイアウォールにフィルタリングルールを追加して適用させます。<br>
引数には、チェイン（-c）とアクション（-a）、ルールの内容をオプションで指定します。<br><br>
外部からのICMPパケットを拒否するルールを追加する例：
```
nfw-ctl add -c INPUT -p ICMP -a DROP
```
### ルールの更新（`update`）
`update`コマンドは、指定したルールの任意の項目を変更してファイアウォールに適用します。<br>
引数には、変更したいルールの行番号とチェイン（-c）、変更内容をオプションで指定します。<br><br>
INPUTチェインの1番目のルールのアクションをDROPに変更する例：
```
nfw-ctl update 1 -c INPUT -a DROP
```
### ルールの削除（`delete`, `clear`）
`delete`コマンドは、指定したルールを削除してファイアウォールに適用します。<br>
引数には、削除したいルールの行番号とチェイン（-c）を指定します。<br><br>
OUTPUTチェインの一行目のルールを削除する例：
```
nfw-ctl delete 1 -c OUTPUT
```
INPUTとOUTPUT、全てのルールを削除するには`clear`コマンドを使用します。
```
nfw-ctl clear
```
### ルールのインポート・エクスポート（`import`, `export`）
`import`コマンドは、外部ルールファイルの内容をインポートしてファイアウォールに適用します。
引数には、外部ファイルのパスを指定します。
```
nfw-ctl import import_file.csv
```
`export`コマンドは、現在のルールを指定したファイルに出力します。
引数には、出力先のファイル名を指定します。
```
nfw-ctl export export_file.csv
```
### デフォルトポリシーの設定（`policy`）
`policy`コマンドは、どのルールとも一致しなかったパケットの処理を設定します。<br>
引数には、チェイン（-c）とアクション（-a）を指定します。<br><br>
INPUTチェインのデフォルトポリシーをDROPに設定する例：
```
nfw-ctl policy -c INPUT -a DROP
```
この設定により、外部からのパケットがどのフィルタリングルールとも一致しなかった場合に拒否されるようになります。
### デフォルトのログ設定（`logging`）
`logging`コマンドは、どのルールとも一致しなかったパケットのログ取得の有無を設定します。<br>
引数には、ログの有無（-l）を表すオプションを指定します。<br><br>
デフォルトログを有効にする例：
```
nfw-ctl logging -l LOG
```
### 設定ファイルの再読み込み（`reload`）
`reload`コマンドは、現在の設定ファイル（`config/firewall.conf`）の内容をファイアウォールに適用させます。
設定ファイルの内容を変更した際に使用します。
```
nfw-ctl reload
```
### ヘルプの表示（`help`）
`help`コマンドからも`nfw-ctl`の使い方を確認できます。
```
nfw-ctl help
```